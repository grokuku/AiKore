name: Build Performance Wheels

on:
  workflow_dispatch: # Allows manual triggering from the Actions tab

jobs:
  build_wheels:
    name: Build for SM_${{ matrix.arch }}
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        arch: ["8.0", "8.6", "8.7", "8.9", "9.0", "9.0a", "10", "12"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create wheels directory on host
        run: mkdir -p wheels

      - name: Build wheels in Docker
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          docker run --rm --gpus all \
            -v "${{ github.workspace }}/wheels":/output_wheels \
            -e TORCH_CUDA_ARCH_LIST=${ARCH} \
            -e MAX_JOBS=8 \
            nvidia/cuda:13.0.1-cudnn-devel-ubuntu24.04 \
            sh -c '
              set -x

              echo "--- Installing Build Dependencies ---"
              apt-get update
              apt-get install -y ninja-build python3-pip git
              pip install --break-system-packages wheel packaging scikit-build-core
              
              echo "--- Installing PyTorch ---"
              pip install --break-system-packages torch torchvision --index-url https://download.pytorch.org/whl/cu130
              
              echo "--- Building sageattention for SM_${ARCH} ---"
              git clone https://github.com/thu-ml/SageAttention.git
              cd SageAttention
              python3 setup.py bdist_wheel
              # This might fail if no wheel is produced, but we will ignore for now
              mv dist/*.whl /output_wheels/ || echo "No sageattention wheel found to move."
              cd ..

              echo "--- Building bitsandbytes for SM_${ARCH} ---"
              git clone https://github.com/TimDettmers/bitsandbytes.git
              cd bitsandbytes
              
              echo "--- pyproject.toml before modification ---"
              cat pyproject.toml

              echo "--- Attempting to modify pyproject.toml ---"
              sed -i "/^[[:space:]]*license-files =/d" pyproject.toml
              SED_EXIT_CODE=$?
              echo "--- sed command finished with exit code: ${SED_EXIT_CODE} ---"

              echo "--- pyproject.toml after modification ---"
              cat pyproject.toml

              if [ ${SED_EXIT_CODE} -ne 0 ]; then
                  echo "--- sed command failed. Exiting. ---"
                  exit ${SED_EXIT_CODE}
              fi

              echo "--- Running bitsandbytes build command ---"
              python3 setup.py bdist_wheel
              BUILD_EXIT_CODE=$?
              echo "--- bitsandbytes build finished with exit code: ${BUILD_EXIT_CODE} ---"
              
              if [ ${BUILD_EXIT_CODE} -ne 0 ]; then
                  echo "--- bitsandbytes build failed. Exiting. ---"
                  exit ${BUILD_EXIT_CODE}
              fi

              echo "--- Moving bitsandbytes wheel ---"
              mv dist/*.whl /output_wheels/ || echo "No bitsandbytes wheel found to move."
              cd ..
            '
      
      - name: Upload Wheels as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sm-${{ matrix.arch }}
          path: wheels/

  publish_release:
    name: Publish Wheels to Release
    runs-on: ubuntu-latest
    needs: build_wheels # This job runs after all matrix jobs are successful
    
    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-wheels/ # The final slash is important

      - name: List downloaded files
        run: ls -R all-wheels/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # This will create a release with a tag like 'wheels-build-123'
          tag_name: wheels-build-${{ github.run_number }}
          name: "Pre-compiled Wheels - Build ${{ github.run_number }}"
          body: "Pre-compiled wheels for sageattention and bitsandbytes for various architectures."
          files: all-wheels/**/*.whl
