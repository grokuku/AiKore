name: Build Performance Wheels

on:
  workflow_dispatch: # Allows manual triggering from the Actions tab

jobs:
  build_wheels:
    name: Build for SM_${{ matrix.arch }}
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        arch: ["8.0", "8.6", "8.7", "8.9", "9.0", "9.0a", "10", "12"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create wheels directory on host
        run: mkdir -p wheels

      - name: Build wheels in Docker
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          set -ex

          echo "--- Installing Build Dependencies ---"
          apt-get update
          apt-get install -y ninja-build python3-pip git
          pip install --break-system-packages wheel packaging scikit-build-core
          
          echo "--- Installing PyTorch ---"
          pip install --break-system-packages torch torchvision --index-url https://download.pytorch.org/whl/cu130
          
          # --- Building sageattention ---
          echo "--- Building sageattention for SM_${ARCH} ---"
          git clone https://github.com/thu-ml/SageAttention.git || { echo "Failed to clone SageAttention"; exit 1; }
          cd SageAttention
          python3 setup.py bdist_wheel
          BUILD_SA_EXIT_CODE=$?
          if [ ${BUILD_SA_EXIT_CODE} -ne 0 ]; then
              echo "--- SageAttention build failed with exit code: ${BUILD_SA_EXIT_CODE}. Continuing to next build if possible. ---"
          else
              SA_WHEEL=$(find dist -name "*.whl" -print -quit)
              if [ -n "$SA_WHEEL" ]; then
                  echo "--- Moving SageAttention wheel: $SA_WHEEL ---"
                  mv "$SA_WHEEL" /output_wheels/
              else
                  echo "--- No SageAttention wheel found in dist/. ---"
              fi
          fi
          cd .. || { echo "Failed to change directory back from SageAttention"; exit 1; }


          # --- Building bitsandbytes ---
          echo "--- Building bitsandbytes for SM_${ARCH} ---"
          git clone https://github.com/TimDettmers/bitsandbytes.git || { echo "Failed to clone bitsandbytes"; exit 1; }
          cd bitsandbytes
          
          echo "--- pyproject.toml before modification ---"
          cat pyproject.toml

          echo "--- Attempting to modify pyproject.toml using Python script directly ---"
          # Using python3 -c to execute the script directly, avoiding YAML here-document issues.
          python3 -c "
import sys
with open('pyproject.toml', 'r') as f:
    lines = f.readlines()
with open('pyproject.toml', 'w') as f:
    for line in lines:
        if 'license-files' not in line:
            f.write(line)
"
          PYTHON_EXIT_CODE=$?
          echo "--- Python script finished with exit code: ${PYTHON_EXIT_CODE} ---"

          if [ ${PYTHON_EXIT_CODE} -ne 0 ]; then
              echo "--- Python script failed. Exiting bitsandbytes build. ---"
              exit ${PYTHON_EXIT_CODE}
          fi

          echo "--- pyproject.toml after modification ---"
          cat pyproject.toml

          echo "--- Running bitsandbytes build command ---"
          python3 setup.py bdist_wheel
          BUILD_BNB_EXIT_CODE=$?
          echo "--- bitsandbytes build finished with exit code: ${BUILD_BNB_EXIT_CODE} ---"
          
          if [ ${BUILD_BNB_EXIT_CODE} -ne 0 ]; then
              echo "--- bitsandbytes build failed with exit code: ${BUILD_BNB_EXIT_CODE}. ---"
              exit ${BUILD_BNB_EXIT_CODE} # Exit if bitsandbytes fails, as it's critical
          else
              BNB_WHEEL=$(find dist -name "*.whl" -print -quit)
              if [ -n "$BNB_WHEEL" ]; then
                  echo "--- Moving bitsandbytes wheel: $BNB_WHEEL ---"
                  mv "$BNB_WHEEL" /output_wheels/
              else
                  echo "--- No bitsandbytes wheel found in dist/. ---"
              fi
          fi
          cd .. || { echo "Failed to change directory back from bitsandbytes"; exit 1; }
      
      - name: Upload Wheels as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sm-${{ matrix.arch }}
          path: wheels/

  publish_release:
    name: Publish Wheels to Release
    runs-on: ubuntu-latest
    needs: build_wheels
    
    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-wheels/

      - name: List downloaded files
        run: ls -R all-wheels/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: wheels-build-${{ github.run_number }}
          name: "Pre-compiled Wheels - Build ${{ github.run_number }}"
          body: "Pre-compiled wheels for sageattention and bitsandbytes for various architectures."
          files: all-wheels/**/*.whl