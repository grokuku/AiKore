# .github/workflows/build-pytorch-wheel.yml
name: "Build and Release PyTorch Wheel"

on:
  push:
    tags:
      - 'torch-v*.*.*'

jobs:
  build-pytorch:
    name: Compile and Release PyTorch wheel
    runs-on: self-hosted
    permissions:
      contents: write # Required to create releases

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract PyTorch version from Git tag
        id: get_version
        # Extracts 'vX.Y.Z' from 'torch-vX.Y.Z'
        run: echo "PYTORCH_VERSION=$(echo ${{ github.ref_name }} | cut -d '-' -f 2-)" >> $GITHUB_ENV

      - name: Build PyTorch wheel
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./pytorch.Dockerfile
          push: false
          target: final
          outputs: type=local,dest=./wheel_output
          build-args: |
            PYTORCH_TAG=${{ env.PYTORCH_VERSION }}
            # These can be customized if needed in the future
            BASE_IMAGE_TAG=13.0.1-cudnn-devel-ubuntu24.04
            TORCH_CUDA_ARCH_LIST=8.9

      - name: List output files
        run: ls -R ./wheel_output

      - name: Create GitHub Release and Upload Wheel
        uses: softprops/action-gh-release@v2
        with:
          # The release will be named after the tag that triggered the workflow
          tag_name: ${{ github.ref_name }}
          # The body of the release
          body: "Pre-compiled PyTorch wheel for version ${{ env.PYTORCH_VERSION }}. Built for CUDA 13.0 and SM_89."
          # The files to upload as assets
          files: ./wheel_output/dist/*.whl
