name: Build xformers Wheel

on:
  workflow_dispatch:

jobs:
  build_xformers_wheel:
    name: Build xformers for SM_${{ matrix.arch }}
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        arch: ["9.0a"] # Temporarily limited for debugging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create wheels directory on host
        run: mkdir -p wheels_xformers

      - name: Clone xformers and get hash
        id: clone_xformers
        run: |
          git clone https://github.com/facebookresearch/xformers.git
          cd xformers
          echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Cache xformers build directory
        uses: actions/cache@v4
        id: cache-build
        with:
          path: xformers/build
          key: ${{ runner.os }}-xformers-build-${{ matrix.arch }}-${{ steps.clone_xformers.outputs.hash }}

      - name: Build wheel in Docker
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          docker run --rm --gpus all \
            -v "${{ github.workspace }}/wheels_xformers":/output_wheels \
            -v "${{ github.workspace }}/xformers":/xformers \
            -e TORCH_CUDA_ARCH_LIST=${ARCH} \
            -e MAX_JOBS=8 \
            nvidia/cuda:13.0.1-cudnn-devel-ubuntu24.04 \
            sh -c '
              set -x

              echo "--- Installing Dependencies ---"
              apt-get update && apt-get install -y ninja-build python3-pip git
              pip install --break-system-packages wheel packaging scikit-build-core torch torchvision --index-url https://download.pytorch.org/whl/cu130
              
              cd /xformers
              
              echo "--- Initializing submodules ---"
              git submodule update --init --recursive
              
              echo "--- Running build command ---"
              python3 setup.py bdist_wheel
              BUILD_EXIT_CODE=$?
              echo "--- Build command finished with exit code: ${BUILD_EXIT_CODE} ---"

              if [ ${BUILD_EXIT_CODE} -ne 0 ]; then
                  echo "--- Build failed with a non-zero exit code. ---"
                  exit ${BUILD_EXIT_CODE}
              fi

              echo "--- Listing dist/ directory ---"
              ls -lR dist/

              echo "--- Moving wheel file ---"
              mv dist/*.whl /output_wheels/
              MOVE_EXIT_CODE=$?
              echo "--- Move command finished with exit code: ${MOVE_EXIT_CODE} ---"

              if [ ${MOVE_EXIT_CODE} -ne 0 ]; then
                  echo "--- Move failed. No wheel file was found. ---"
                  exit ${MOVE_EXIT_CODE}
              fi

              echo "--- Final check of output directory ---"
              ls -lR /output_wheels/
            '
      
      - name: Upload Wheels as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: xformers-wheel-sm-${{ matrix.arch }}
          path: wheels_xformers/

  publish_xformers_release:
    name: Publish xformers Wheel to Release
    runs-on: ubuntu-latest
    needs: build_xformers_wheel
    
    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-xformers-wheels/

      - name: List downloaded files
        run: ls -R all-xformers-wheels/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: xformers-wheels-build-${{ github.run_number }}
          name: "Pre-compiled xformers Wheels - Build ${{ github.run_number }}"
          body: "Pre-compiled wheels for xformers for various architectures (up to SM_9.0a)."
          files: all-xformers-wheels/**/*.whl
